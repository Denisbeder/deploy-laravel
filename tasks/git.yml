- name: Git config list
  command: git config --list
  register: gitconfig

- name: Pesquisa e atribui o valor do domÃ­nio
  set_fact:
    git_config_domain: "{{ gitconfig.stdout_lines | regex_search(domain) }}"

- name: Add the domain as safe.directory in git config
  command: git config --global --add safe.directory "{{ domain_path }}"
  when: not git_config_domain

- name: Add github.com to known_hosts if it doesn't exist yet
  known_hosts:
    name: github.com
    key: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com 2>/dev/null') }}"
    path: "~/.ssh/known_hosts"
    state: present

- name: Clone repository
  git:
    repo: "{{ repository }}"
    dest: "{{ domain_path }}"
    version: "{{ repository_version }}"
    force: yes
    update: yes
    accept_hostkey: yes
  tags:
    - deploy_laravel
